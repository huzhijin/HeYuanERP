# HeYuanERP 订单状态管理系统

## 概述

本系统实现了完整的订单状态流转管理，支持从草稿到关闭的全生命周期状态控制，包含权限验证、状态变更日志记录等功能。

## 状态流转图

```
   Draft (草稿)
      ↓
   Submitted (已提交)
      ↓
   Confirmed (已确认)
      ↓
   InProduction (生产中)
      ↓
   PartialDelivered (部分发货) → PartialInvoiced (部分开票)
      ↓                              ↓
   Delivered (已发货) ────────→ Invoiced (已开票)
      ↓                              ↓
      └────────→ Closed (已关闭) ←─────┘

   任何状态都可以 → Cancelled (已取消)
```

## 核心组件

### 1. 状态枚举 (`OrderStatus`)

```csharp
public enum OrderStatus
{
    Draft = 0,           // 草稿
    Submitted = 1,       // 已提交
    Confirmed = 2,       // 已确认
    InProduction = 3,    // 生产中
    PartialDelivered = 4,// 部分发货
    Delivered = 5,       // 已发货
    PartialInvoiced = 6, // 部分开票
    Invoiced = 7,        // 已开票
    Closed = 8,          // 已关闭
    Cancelled = 9        // 已取消
}
```

### 2. 状态变更日志 (`OrderStatusLog`)

记录所有状态变更的历史，包括：
- 原状态和目标状态
- 变更原因
- 操作人信息
- 客户端信息（IP、User-Agent）
- 时间戳

### 3. 状态流转服务 (`IOrderStateService`)

提供核心的状态管理功能：
- `CanTransitionAsync()` - 检查是否可以流转
- `TransitionAsync()` - 执行状态流转
- `GetAllowedTransitionsAsync()` - 获取可流转状态列表
- `GetStatusHistoryAsync()` - 获取状态变更历史

## API 接口

### 状态查询接口

```http
GET /api/orders/{id}/transitions
```

获取订单当前可流转的状态列表。

**响应示例：**
```json
[
  {
    "status": "confirmed",
    "statusName": "已确认",
    "styleClass": "status-confirmed"
  },
  {
    "status": "cancelled",
    "statusName": "已取消",
    "styleClass": "status-cancelled"
  }
]
```

### 状态流转接口

```http
POST /api/orders/{id}/transition
Content-Type: application/json

{
  "targetStatus": "confirmed",
  "reason": "客户确认订单内容"
}
```

**响应示例：**
```json
{
  "success": true,
  "newStatus": "confirmed",
  "newStatusName": "已确认",
  "logId": "abc123...",
  "message": "订单状态已更新为: 已确认"
}
```

### 状态历史接口

```http
GET /api/orders/{id}/status-history
```

获取订单的完整状态变更历史。

### 快捷操作接口

系统提供了一系列快捷操作接口：

- `POST /api/orders/{id}/submit` - 提交订单
- `POST /api/orders/{id}/start-production` - 开始生产
- `POST /api/orders/{id}/close` - 关闭订单
- `POST /api/orders/{id}/cancel` - 取消订单

## 权限控制

订单状态管理采用细粒度的权限控制：

| 操作 | 权限代码 | 说明 |
|------|----------|------|
| 提交订单 | `orders.submit` | 将草稿订单提交审核 |
| 确认订单 | `orders.confirm` | 确认订单进入生产流程 |
| 生产管理 | `orders.production` | 管理生产状态 |
| 发货管理 | `orders.delivery` | 管理发货状态 |
| 开票管理 | `orders.invoice` | 管理开票状态 |
| 关闭订单 | `orders.close` | 正常关闭订单 |
| 取消订单 | `orders.cancel` | 取消订单 |

## 业务规则

### 状态流转规则

1. **Draft → Submitted**: 无特殊限制
2. **Submitted → Confirmed**: 必须有订单行
3. **Confirmed → InProduction**: 可以添加库存检查逻辑
4. **任何状态 → Delivered**: 必须有确认的发货记录
5. **任何状态 → Invoiced**: 发票金额必须与订单金额匹配
6. **终止状态**: Closed 和 Cancelled 状态无法再流转

### 业务验证

系统在状态流转时会执行相应的业务验证：

- **确认订单**: 检查是否有订单行
- **标记发货**: 检查是否有发货记录
- **标记开票**: 检查发票金额与订单金额是否匹配

### 后置处理

状态变更后会自动执行相应的业务逻辑：

- **取消订单**: 自动取消相关发货单，释放预留库存
- **关闭订单**: 更新客户最后交易时间

## 数据库表结构

### OrderStatusLogs 表

```sql
CREATE TABLE OrderStatusLogs (
    Id NVARCHAR(32) PRIMARY KEY,
    OrderId NVARCHAR(32) NOT NULL,
    FromStatus INT NOT NULL,
    ToStatus INT NOT NULL,
    Reason NVARCHAR(500),
    ChangedAt DATETIME2 NOT NULL,
    ChangedBy NVARCHAR(32),
    ChangedByName NVARCHAR(100),
    ClientIp NVARCHAR(45),
    UserAgent NVARCHAR(500),
    ExtensionData NVARCHAR(MAX)
);
```

## 前端集成指南

### 状态显示

使用状态扩展方法获取显示信息：

```csharp
var status = OrderStatus.Confirmed;
var displayName = status.GetDisplayName(); // "已确认"
var styleClass = status.GetStyleClass();   // "status-confirmed"
```

### CSS 样式类

系统为每个状态提供了对应的样式类：

```css
.status-draft { color: #6c757d; }
.status-submitted { color: #007bff; }
.status-confirmed { color: #28a745; }
.status-production { color: #fd7e14; }
.status-partial-delivered { color: #20c997; }
.status-delivered { color: #17a2b8; }
.status-partial-invoiced { color: #6f42c1; }
.status-invoiced { color: #e83e8c; }
.status-closed { color: #343a40; }
.status-cancelled { color: #dc3545; }
```

### 状态流转组件

前端可以基于API构建状态流转组件：

1. 调用 `/transitions` 接口获取可操作状态
2. 渲染状态按钮
3. 点击后调用 `/transition` 接口执行流转
4. 显示操作结果并刷新状态

## 扩展指南

### 添加新状态

1. 在 `OrderStatus` 枚举中添加新状态
2. 在 `TransitionMatrix` 中定义流转规则
3. 在 `StatusPermissions` 中添加权限映射
4. 在业务验证和后置处理中添加相应逻辑

### 自定义业务规则

在 `OrderStateService` 的以下方法中添加自定义逻辑：

- `ValidateTransitionAsync()` - 添加状态流转前的业务验证
- `ExecuteTransitionBusinessLogicAsync()` - 添加状态流转后的业务处理

## 测试用例

系统应该包含以下测试场景：

1. **正常流转**: 测试完整的状态流转链路
2. **权限控制**: 测试无权限用户的访问控制
3. **业务验证**: 测试各种业务规则的验证
4. **并发安全**: 测试并发状态变更的处理
5. **异常处理**: 测试各种异常情况的处理

## 监控和日志

- 所有状态变更都会记录到 `OrderStatusLogs` 表
- 建议添加状态变更的业务监控指标
- 可以基于状态变更日志进行业务分析

## 性能优化

- 状态查询使用了适当的数据库索引
- 批量状态更新支持事务处理
- 状态历史查询支持分页（可扩展）

---

**注意事项**：
1. 状态流转是不可逆的，请谨慎操作
2. 状态变更会触发相关业务流程，请确保理解业务影响
3. 建议在生产环境部署前进行充分的集成测试