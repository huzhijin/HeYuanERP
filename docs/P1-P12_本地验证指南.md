# HeYuanERP 本地验证指南（P1–P12，macOS + SQLite + Rider）

> 目标：按“先登录后鉴权”的顺序，从 P1 到 P12 覆盖核心链路，确保你能在本机用最少的操作完成端到端验证。默认数据库使用 SQLite；打印使用 Playwright（Chromium Headless）。

---

## 0. 环境准备（一次性）
- macOS（Apple Silicon 或 Intel 均可）
- .NET 8 SDK
- Rider（或 VS Code + C#）
- Node.js 20 LTS（用于前端）
- 可选：PowerShell（Playwright 脚本，更方便）

---

## 1. 后端启动（Rider 推荐）
1) 打开解决方案：`Downloads/HeYuanERP/HeYuanERP_Server/HeYuanERP.sln`
2) 选择启动项目：`src/HeYuanERP.Api/HeYuanERP.Api.csproj`
3) Run/Debug Configuration 设置环境变量：
   - `ASPNETCORE_ENVIRONMENT=Development`
   - `CONNECTION_STRING=Data Source=heyuanerp_dev.db`
   - `JWT__ISSUER=heyuanerp`
   - `JWT__AUDIENCE=heyuanerp.web`
   - `JWT__SECRET=LocalDev_ChangeMe_123456`
   - `CORS__ALLOWEDORIGINS=http://localhost:5173`
4) 运行（▶️）。首次启动会：
   - 自动 EnsureCreated 并开发播种（默认账号/权限、演示基础数据）
   - 监听地址：`http://localhost:5180`，Swagger：`/swagger`

> 提示：Development 环境下默认播种用户为 `admin / CHANGE_ME`。

---

## 2. Playwright 安装（打印所需，一次性）
- 在后端输出目录执行安装（联网）：

```bash
cd Downloads/HeYuanERP/HeYuanERP_Server/src/HeYuanERP.Api
# 先构建一次，生成 playwright 脚本
(dotnet build)
# 安装浏览器内核（推荐 PowerShell）
pwsh bin/Debug/net8.0/playwright.ps1 install --with-deps || \
./bin/Debug/net8.0/playwright.sh install --with-deps
```

> 如无法联网，可先跳过打印验证；其余 P1–P11 流程不受影响。

---

## 3. 前端启动
```bash
cd Downloads/HeYuanERP/heyuan-erp-web
cp .env.development.example .env.development 2>/dev/null || true
# 确保如下变量：
# VITE_API_BASE_URL=http://localhost:5180
# VITE_ENABLE_MOCK_OA=true
# VITE_ENABLE_MOCK_AI=true
npm ci
npm run dev
```
- 打开浏览器：`http://localhost:5173`
- 登录：`admin / CHANGE_ME`

---

## 4. API 快速校验（VSCode/Rider REST 或 curl）
本仓库提供 `docs/api_smoke.http`，可直接在 Rider/VSCode 的 REST 插件中运行。

也可使用 curl：
- 登录获取 Token：
```bash
curl -sS -X POST http://localhost:5180/api/auth/login \
  -H 'Content-Type: application/json' \
  -d '{"loginId":"admin","password":"CHANGE_ME"}' | jq
```
- 受保护接口（示例 Accounts 列表）：
```bash
TOKEN="<上一步返回的 data.token>"
curl -sS http://localhost:5180/api/accounts -H "Authorization: Bearer $TOKEN" | jq
```

---

## 5. P1–P12 分项验证（按顺序）

### P1 基础设施（健康检查/Swagger/日志）
- 访问 `GET /health`（或 `HealthController` 显示的地址）→ 200 OK
- 打开 Swagger：`/swagger` → 控制器与 DTO 显示正常
- 控制台日志显示 TraceId（开发期默认日志，Serilog/OTel 可后续接入）

### P2 安全（登录、JWT、RBAC）
- 登录：`POST /api/auth/login`（admin/CHANGE_ME）→ 返回 token + 用户 + 角色
- 受保护接口（如 `/api/accounts`）携带 `Authorization: Bearer <token>` → 200
- 若不带 Token/或非权限用户 → 401/403

### P3 统一响应与分页
- 大多数接口返回 `ApiResponse<T>`：`{"code":0,"message":"OK","data":...}`
- 分页口径：请求 `page/pageSize`，返回包含 `total/page/pageSize`（按控制器实际实现为准）

### P4 用户/角色/权限
- 验证播种：`admin` 角色 = `Admin`；权限覆盖 `accounts.* / orders.* / inventory.read / print.read` 等
- 校验：访问需要 `accounts.read` 的接口（/api/accounts）能成功；换成无权限用户（若已有）得到 403

### P5 订单/交货/退货（核心单据）
- 订单：`GET /api/orders`、`GET /api/orders/{id}`、`POST /api/orders`（如已实现）
- 交货/退货：`GET /api/deliveries`、`POST /api/deliveries`、`GET /api/returns`、`POST /api/returns`
- 打印相关数据组装器已就绪（Order/Delivery/POReceive Assembler），用于模板展示字段齐套性检查

### P6 采购/收货/导入
- 采购单：`GET /api/purchase-orders`、`POST /api/purchase-orders`
- 收货：`GET /api/po-receives`、`POST /api/po-receives`
- Excel 导入（如已开放）：`POST /api/po/import`（multipart，详见 Swagger）

### P7 库存/仓库/库位
- 仓库：`GET /api/warehouses`、库位：`GET /api/locations`
- 库存汇总/流水：`GET /api/inventory/summary`、`GET /api/inventory/transactions`
- 验证查询参数（产品/仓库/库位/时间范围）与返回结构

### P8 发票/电票
- 发票：`GET /api/invoices`、`POST /api/invoices`、`GET /api/invoices/{id}`
- 电票信息（若已实现）：查看 `InvoicePrintController` 或 Swagger 中的电票相关接口

### P9 收款/对账（附件上传）
- 列表：`GET /api/payments?page=1&pageSize=10`
- 新建（multipart）：`POST /api/payments`（字段：method/amount/paymentDate/remark + attachments[]）
- 详情：`GET /api/payments/{id}` → 附件列表字段存在
- 对账 CSV 导出：`GET /api/reconciliation/export?dateFrom=2025-09-01&dateTo=2025-09-11&method=银行转账` → 下载 CSV（UTF-8 BOM）

### P10 报表（销售/开票/采购/库存）
- 销售统计：`GET /api/reports/sales-stat?groupBy=day&from=2025-09-01&to=2025-09-11`
- 发票统计：`GET /api/reports/invoice-stat?groupBy=day&from=...`
- 采购查询：`GET /api/reports/po-query?page=1&size=20&from=...`
- 库存汇总/流水：`GET /api/reports/inventory/summary`、`GET /api/reports/inventory/transactions`
- 导出任务：`POST /api/reports/export/{name}`（name=sales|invoice|po|inventory），返回 TaskId；`GET /api/reports/export/tasks/{taskId}` 查看状态

> 说明：报表引擎/参数白名单已完备；部分统计查询可能返回占位数据，便于先校验口径与导出流程。

### P11 OA/AI（Mock）
- 默认开启 Mock（可在配置中切换）
- 通过日志/审计可见外部调用占位与返回；前端可在页面显示待办/AI 结果（若对应页面已挂接）

### P12 统一打印（Chromium Headless）
- 安装 Playwright（见第 2 节）
- 打印接口：`GET /api/print/{docType}/{id}?template=default`
  - docType 示例：`order` / `delivery` / `poreceive` / `invoice` / `statement`
- 期望：返回 `application/pdf` 二进制，文件名 `{docType}-{id}.pdf`
- 检查点：中文字体、边距、分页、图片/Logo、占位符替换是否正确

---

## 6. 常见问题速查
- 登录失败（401）：确认使用 `admin / CHANGE_ME`；Rider 启动为 Development；数据库是否已 EnsureCreated
- 受保护接口 403：确认 JWT 中 `perm` 声明包含对应权限；或使用 `Admin` 用户
- SQLite 表不存在：删除 `heyuanerp_dev.db` 后重启（Development 会 EnsureCreated），或手动执行 EF 迁移
- Playwright 安装失败：更换网络环境，或先跳过打印验证

---

## 7. 一键脚本（可选）
- 安装 Playwright（在 API 目录）：

```bash
# scripts/install-playwright-browsers.sh （示例脚本）
#!/usr/bin/env bash
set -euo pipefail
cd "$(dirname "$0")/../src/HeYuanERP.Api"
dotnet build
if command -v pwsh >/dev/null 2>&1; then
  pwsh bin/Debug/net8.0/playwright.ps1 install --with-deps
else
  ./bin/Debug/net8.0/playwright.sh install --with-deps
fi
```

---

## 8. 验收清单（P1–P12）
- [ ] Swagger 可访问，健康检查 200
- [ ] 登录成功，受保护接口 200（无 Token/无权限 401/403）
- [ ] 统一响应：`code/message/data`，分页口径一致
- [ ] 用户/角色/权限：Admin 拥有全部权限，账户权限准确生效
- [ ] 订单/交货/退货：列表/详情/创建/状态流（如已实现）
- [ ] 采购/收货/导入：基础流程（如已实现）
- [ ] 库存：汇总与流水查询可返回数据
- [ ] 发票：列表/创建/详情（如已实现）
- [ ] 收款：列表/创建（含附件）/详情；对账 CSV 导出
- [ ] 报表：查询与导出任务流；参数白名单生效
- [ ] 打印：Playwright PDF 正常（中文、分页、Logo、版式）

---

## 附：端到端最小串（CLI）
```bash
# 登录
TOKEN=$(curl -sS -X POST http://localhost:5180/api/auth/login \
  -H 'Content-Type: application/json' \
  -d '{"loginId":"admin","password":"CHANGE_ME"}' | jq -r '.data.token')

# 访问受保护接口
curl -sS http://localhost:5180/api/accounts -H "Authorization: Bearer $TOKEN" | jq

# 新建收款（multipart 示例）
curl -sS -X POST http://localhost:5180/api/payments \
  -H "Authorization: Bearer $TOKEN" \
  -F method=银行转账 -F amount=123.45 -F paymentDate=2025-09-11 -F remark=测试 \
  -F attachments=@/path/to/sample.pdf | jq

# 打印（需已存在的单据 id）
# curl -v -L -o order-123.pdf "http://localhost:5180/api/print/order/123?template=default" \
#   -H "Authorization: Bearer $TOKEN"
```

---

如需我代为安装 Playwright 并生成一个样例 PDF，请告知，我可在你允许联网的情况下直接执行安装与打印验收。若你在某一步遇到问题，按“章节编号 + 步骤号 + 日志/返回”反馈，我会基于该点快速定位。

