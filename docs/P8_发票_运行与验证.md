# P8 发票 — 运行与验证步骤

本指南覆盖后端与前端的本地运行与功能验证，确保“从订单/交货开票 + 打印”链路可用。

## 一、环境准备
1. 复制根目录 `.env.example` 为 `.env` 并按需修改：
   - `DB_CONNECTION`（或使用 `DB_PROVIDER=sqlite` + `SQLITE_CONNECTION`）
   - `JWT__Issuer`、`JWT__Audience`、`JWT__Secret`
   - 打印服务：`PRINTING_BASE_URL`（必填）、`PRINTING_API_KEY`（可选）
2. 确认后端端口：`ASPNETCORE_URLS=http://localhost:5080`
3. 确认前端代理：`VITE_API_BASE=http://localhost:5080`

## 二、后端启动
```bash
cd Downloads/HeYuanERP/HeYuanERP_Server/src/HeYuanERP.Api
dotnet build
dotnet run
```
验证：
- `GET /healthz` 返回 200
- `GET /swagger` 可访问

## 三、前端启动
```bash
cd Downloads/HeYuanERP/heyuan-erp-web
npm i
npm run dev
```
访问：http://localhost:5173

## 四、功能验证
1. 进入“发票列表” `/invoices`，应能加载分页数据（若为空显示空表）。
2. 点击“新建发票”或直接访问 `/invoices/new`：
   - 选择来源类型（订单/交货），输入来源 Id（GUID）并“拉取明细”；
   - 检查行已回填（交货来源的单价需手工录入）；
   - 编辑必要字段后“提交”，提示成功并跳转详情页。
3. 在“发票详情”页 `/invoices/:id`：
   - 核对头部字段与金额计算；
   - 点击“打印”，浏览器新窗口打开 PDF（需保证 P11 打印服务可用）。

## 五、自检清单
- [ ] 环境变量就绪（含 PRINTING_*）
- [ ] 后端可运行、Swagger 正常
- [ ] 前端可运行、路由可达（/invoices、/invoices/new、/invoices/:id）
- [ ] 新建发票成功并可打印

## 六、常见问题
- 打印失败：检查 `PRINTING_BASE_URL` 是否指向可用的 P11 服务；必要时使用 Mock/占位服务。
- 401/403：请先登录获取 JWT，或在开发环境关闭前端路由守卫的强制跳转（仅限本地调试）。

