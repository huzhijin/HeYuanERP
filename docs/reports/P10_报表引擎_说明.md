# P10 报表引擎（Plan A）实现说明

> 本文档面向研发与测试，说明报表引擎在 .NET 8 + Vue 3 架构下的设计、接口、运行与验证步骤。所有描述、示例与日志口径为中文。

## 1. 目标与范围

- 报表类型：销售统计（SalesStat）、发票统计（InvoiceStat）、采购订单查询（POQuery）、库存（Inventory）。
- 能力覆盖：参数白名单与校验、异步导出（PDF/CSV）、快照（文件URI+参数+审计）、统一响应与分页对齐 OpenAPI。
- 安全与追踪：JWT + RBAC、Serilog 日志、OpenTelemetry Trace（通过 CorrelationId 贯通）。

## 2. 架构总览

- 后端（HeYuanERP_Server）
  - Application 层：
    - ReportEngine：统一报表查询与导出负载构建。
    - 参数白名单与绑定：ReportParameterWhitelist（过滤/规范化/绑定强类型）。
    - 校验：FluentValidation（参数与分页等）。
    - 导出器：CsvExporter、ChromiumPdfExporter（可从 Columns/Rows 或 PrintUrl/Html 渲染）。
    - 导出服务：ReportExportService（创建任务、入队、查询任务状态）。
    - 快照服务：ReportSnapshotService（保存导出结果与参数审计）。
  - Infrastructure 层：EF Core 映射、仓储实现与迁移（ReportJobs、ReportSnapshots）。
  - Api 层：REST 控制器、内存队列 + BackgroundService Worker、依赖注入与启动扩展。

- 前端（heyuan-erp-web）
  - Axios 封装：统一 Envelope 解析（code/message/data/traceId），JWT 头。
  - API 模块：reports.ts 与 TS 类型对齐 OpenAPI。
  - 视图：SalesStat/InvoiceStat/POQuery/Inventory + 打印页（/views/reports/print/*）。
  - Store：reportExport（创建导出任务并轮询任务状态）。
  - 打印样式：public/print.css（Chromium 与浏览器共用）。

## 3. 参数白名单与校验

- 白名单组件：Application/Reports/Validation/ReportParameterWhitelist.cs
  - 输入：`IDictionary<string, object?>`（可从 query 或 body.params）。
  - 输出：仅允许的键（按报表类型）+ 统一化的时间范围 `range.startUtc/endUtc`（ISO8601）。
  - 绑定：`Bind<T>(type, dict)` 将安全参数 JSON 反序列化为强类型 DTO，并对 DateRange 做 Normalize。

- 校验器（FluentValidation）：
  - SalesStatParamsValidator / InvoiceStatParamsValidator：范围合法性与分组枚举。
  - POQueryParamsValidator / InventoryParamsValidator：范围 + 分页 + 字段长度。
  - ReportExportRequestValidator：params 不为空、format ∈ {pdf,csv}。

## 4. 异步导出与快照

1) API 接受导出请求（POST /api/reports/{name}/export）
   - Body: { format?: 'pdf'|'csv', params: {...} }
   - 使用白名单过滤参数，创建 ReportJob（状态 queued），写入 DB 并入队。

2) Worker 消费队列（BackgroundService）
   - 读取 ReportJob → 调用 ReportEngine.BuildExportPayloadAsync → 调用对应导出器导出文件。
   - 成功：更新状态为 succeeded，写入 fileUri、completedAt。
   - 失败：更新状态为 failed，记录 ErrorMessage。

3) 快照（ReportSnapshots）
   - 每个成功的任务将 params JSON 计算 SHA256 哈希（ParamHash），连同 fileUri/审计字段落库，便于复用与追踪。

4) 文件存放与访问
   - 导出器输出根目录：环境变量 REPORTS_OUTPUT_ROOT（默认：进程目录下 exports）。
   - 外网 URL 前缀：REPORTS_PUBLIC_BASE_URL（存在时返回 http(s) URL，否则返回 file://）。
   - Chromium 可执行路径：CHROMIUM_PATH（缺省将按常见路径/可执行名搜索）。

## 5. API 一览（与 OpenAPI 对齐）

- GET /api/reports/sales-stat
- GET /api/reports/invoice-stat
- GET /api/reports/po-query
- GET /api/reports/inventory/summary
- GET /api/reports/inventory/transactions
- POST /api/reports/{name}/export
- GET /api/reports/tasks/{taskId}
- GET /api/reports/snapshots/{id}
- GET /api/reports/snapshots?type=&paramHash=

说明：所有响应均包裹 Envelope（code/message/data/traceId）。分页字段与 OpenAPI 定义一致。

## 6. 环境变量与配置

- 数据库与日志（示例，详见主工程配置）：
  - ConnectionStrings__Default（SQL Server）
  - Serilog__MinimumLevel__Default
  - OTEL_EXPORTER_OTLP_ENDPOINT（可选）
- 报表导出：
  - REPORTS_OUTPUT_ROOT：导出文件根目录。
  - REPORTS_PUBLIC_BASE_URL：公开 URL 前缀。
  - CHROMIUM_PATH：Chromium/Chrome 可执行路径。
  - REPORTS_QUEUE_CAPACITY：导出队列容量（默认 200）。
  - REPORTS_MAX_DOP：Worker 并发数（默认 1）。

## 7. 运行与验证步骤

后端（本地）：
1) 设置环境变量（PowerShell 示例）：
   - `$env:REPORTS_OUTPUT_ROOT="C:\\temp\\hy-exports"`
   - `$env:REPORTS_MAX_DOP="1"`
2) 迁移数据库并启动 API（参考主工程 README：`dotnet ef database update` → `dotnet run`）。
3) 验证接口：
   - GET `/api/reports/sales-stat?from=2024-01-01&to=2024-01-31&groupBy=month`
   - POST `/api/reports/sales-stat/export`（body: { format:"csv", params:{ from:"2024-01-01", to:"2024-01-31" } }）返回任务。
   - 轮询 GET `/api/reports/tasks/{taskId}` 直至 status=completed，并检查 fileUri 可访问。

前端（本地）：
1) 设置 `.env.local`：`VITE_API_BASE_URL=http://localhost:5000`（按实际端口调整）。
2) 运行：`npm ci && npm run dev`。
3) 页面验证：导航至“报表中心”各视图，执行查询与“导出 PDF/CSV”。
4) 打印页验证：直接访问（示例）
   - `/reports/print/SalesStatPrint?from=2024-01-01&to=2024-01-31&groupBy=month`
   - `/reports/print/InvoiceStatPrint?...`
   - `/reports/print/POQueryPrint?...`
   - `/reports/print/InventoryPrint?productId=P1&whse=A`

## 8. 自检清单（研发侧）

- [x] 参数白名单仅放行业务允许键；时间范围标准化；分页范围 1~200。
- [x] FluentValidation 校验覆盖主要 DTO；错误信息为中文；统一 Envelope。
- [x] 异步导出全链路：任务入队→Worker 消费→导出文件→更新状态→创建快照。
- [x] CSV 使用 UTF-8 BOM 便于 Excel；PDF 使用 Chromium Headless。
- [x] 所有连接串与密钥均来自环境变量；不在代码库硬编码。
- [x] 前端不生成 SDK；手写 axios 封装并按 OpenAPI 校验口径。
- [x] 打印样式在 public/print.css；打印页可单独访问与截图对齐。

## 9. 后续事项与扩展点

- 实体查询实现当前为占位（Application 层），需由 Infrastructure 使用 EF Core 落实。
- 报表 PrintUrl 由前端路由提供时，可在 ReportEngine.BuildExportPayloadAsync 设置 payload.PrintUrl，提升 PDF 排版一致性。
- 权限模型：在控制器与服务注册处增加基于 RBAC 的策略标签（如 Policy="Reports.Read"/"Reports.Export"）。
- 对象存储：可将导出文件上传到 OSS/BlobStorage，并以短期签名 URL 返回。

